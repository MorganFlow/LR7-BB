<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Арканоид</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="game-container">
        <div id="mainMenu" class="game-menu">
            <h1>Арканоид</h1>
            <div id="authSection">
                <input type="text" id="username" placeholder="Имя пользователя">
                <input type="email" id="email" placeholder="Email">
                <input type="password" id="password" placeholder="Пароль">
                <button id="registerBtn">Регистрация</button>
                <button id="loginBtn">Вход</button>
                <div id="authError" class="error"></div>
            </div>
            <div class="menu-buttons" id="gameButtons" style="display: none;">
                <button id="startGame">Начать игру</button>
                <button id="settings">Настройки</button>
                <button id="tutorial">Обучение</button>
                <button id="stats">Статистика</button>
                <button id="logout">Выход</button>
            </div>
        </div>

        <!-- Остальные меню без изменений, но в stats добавим лидерборд -->
        <div id="statsMenu" class="stats-menu hidden">
            <h2>Статистика</h2>
            <div id="statsContent" class="stats-window"></div>
            <div id="leaderboardContent"></div>  <!-- Для API лидерборда -->
            <div class="menu-buttons">
                <button id="clearStats">Очистить локальную статистику</button>
                <button id="statsBack">Назад</button>
            </div>
        </div>

        <!-- Game UI с кнопками сохранения -->
        <div id="gameUI" class="game-ui hidden">
            <div class="score-display">
                <span>Уровень: <span id="currentLevel">1</span></span>
                <span>Очки: <span id="currentScore">0</span></span>
                <span>Время: <span id="gameTimer">00:00</span></span>
            </div>
            <button id="saveGame">Сохранить</button>
            <button id="loadGame">Загрузить</button>
            <button id="pauseGame">Пауза</button>
        </div>

        <!-- Чат -->
        <div id="chatContainer" class="chat-container hidden">
            <div id="chatMessages"></div>
            <input type="text" id="chatInput" placeholder="Сообщение...">
            <button id="sendChat">Отправить</button>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <script src="game.js"></script>
    <script>
        const API_URL = 'http://localhost:8000/api/';
        let accessToken = localStorage.getItem('access_token');

        // Аутентификация
        document.getElementById('registerBtn').addEventListener('click', async () => {
            const data = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            };
            const res = await fetch(API_URL + 'register/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            const json = await res.json();
            if (res.ok) {
                localStorage.setItem('access_token', json.access);
                accessToken = json.access;
                showGameButtons();
            } else {
                document.getElementById('authError').textContent = json.error;
            }
        });

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };
            const res = await fetch(API_URL + 'login/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            const json = await res.json();
            if (res.ok) {
                localStorage.setItem('access_token', json.access);
                accessToken = json.access;
                showGameButtons();
            } else {
                document.getElementById('authError').textContent = json.error;
            }
        });

        function showGameButtons() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('gameButtons').style.display = 'flex';
            document.getElementById('chatContainer').classList.remove('hidden');  // Показать чат
            initChat();
        }

        document.getElementById('logout').addEventListener('click', () => {
            localStorage.removeItem('access_token');
            location.reload();
        });

        if (accessToken) showGameButtons();

        // Сохранение/загрузка
        document.getElementById('saveGame').addEventListener('click', async () => {
            const data = {
                game_state: this.getState(),
                score: game.score,  // Из game.js
                level: game.currentLevel,
                time_played: game.elapsedTime / 1000,  // В секундах
                is_completed: false
            };
            await fetch(API_URL + 'game-sessions/', { method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}`}, body: JSON.stringify(data) });
        });

        document.getElementById('loadGame').addEventListener('click', async () => {
            const res = await fetch(API_URL + 'load-session/', { headers: {'Authorization': `Bearer ${accessToken}`} });
            const json = await res.json();
            if (res.ok) {
                game.loadState(json);
            }
        });

        // Лидерборд в stats
        document.getElementById('stats').addEventListener('click', async () => {
            const res = await fetch(API_URL + 'leaderboard/');
            const json = await res.json();
            const leaderboard = document.getElementById('leaderboardContent');
            leaderboard.innerHTML = '<h3>Лидерборд</h3>';
            json.forEach(entry => {
                leaderboard.innerHTML += `<p>${entry.user.username}: ${entry.score}</p>`;
            });
        });

        // Чат WebSocket
        let ws;
        function initChat() {
            ws = new WebSocket(`ws://localhost:8000/ws/chat/?token=${accessToken}`);
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                document.getElementById('chatMessages').innerHTML += `<p>${data.username}: ${data.message}</p>`;
            };
            document.getElementById('sendChat').addEventListener('click', () => {
                const msg = document.getElementById('chatInput').value;
                ws.send(JSON.stringify({message: msg}));
                document.getElementById('chatInput').value = '';
            });
        }

    </script>
</body>
</html>