<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Арканоид</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="game-container">
        <div id="mainMenu" class="game-menu">
            <h1>Арканоид</h1>
            <div id="authSection">
                <input type="text" id="username" placeholder="Имя пользователя">
                <input type="email" id="email" placeholder="Email">
                <input type="password" id="password" placeholder="Пароль">
                <button id="registerBtn">Регистрация</button>
                <button id="loginBtn">Вход</button>
                <div id="authError" class="error"></div>
            </div>
            <div class="menu-buttons" id="gameButtons" style="display: none;">
                <button id="startGame">Начать игру</button>
                <button id="settings">Настройки</button>
                <button id="tutorial">Обучение</button>
                <button id="stats">Статистика</button>
                <button id="logout">Выход</button>
            </div>
        </div>

        <!-- Настройки -->
        <div id="settingsMenu" class="settings-menu hidden">
            <h2>Настройки</h2>
            <div class="setting-option">
                <label for="difficulty">Сложность:</label>
                <select id="difficulty">
                    <option value="easy">Легкий</option>
                    <option value="medium" selected>Средний</option>
                    <option value="hard">Сложный</option>
                </select>
            </div>
            <div class="setting-option">
                <label for="soundVolume">Громкость:</label>
                <input type="range" id="soundVolume" min="0" max="100" value="50">
            </div>
            <button id="saveSettings">Сохранить</button>
            <button id="backToMenu">Назад</button>
        </div>

        <!-- Обучение -->
        <div id="tutorialMenu" class="tutorial-menu hidden">
            <h2>Обучение</h2>
            <div class="tutorial-content">
                <p>Используйте мышь или ← → для платформы.</p>
                <p>Отбивайте шарик, разрушайте блоки.</p>
                <p>Не дайте шарику упасть!</p>
                <p><strong>Бонусы:</strong></p>
                <ul>
                    <li>Зелёный — увеличить платформу</li>
                    <li>Красный — уменьшить</li>
                    <li>Жёлтый — мультиболл</li>
                    <li>Синий — замедлить</li>
                    <li>Фиолетовый — ускорить</li>
                    <li>Оранжевый — +1 жизнь</li>
                </ul>
            </div>
            <button id="tutorialBack">Назад</button>
        </div>

        <!-- Статистика -->
        <div id="statsMenu" class="stats-menu hidden">
            <h2>Статистика</h2>
            <div id="statsContent"></div>
            <div id="leaderboardContent"></div>
            <button id="clearStats">Очистить</button>
            <button id="statsBack">Назад</button>
        </div>

        <!-- UI игры -->
        <div id="gameUI" class="game-ui hidden">
            <div class="score-display">
                <span>Уровень: <span id="currentLevel">1</span></span>
                <span>Очки: <span id="currentScore">0</span></span>
                <span>Время: <span id="gameTimer">00:00</span></span>
            </div>
            <button id="saveGame">Сохранить</button>
            <button id="loadGame">Загрузить</button>
            <button id="pauseGame">Пауза</button>
        </div>

        <!-- Чат -->
        <div id="chatContainer" class="chat-container hidden">
            <div id="chatMessages"></div>
            <input type="text" id="chatInput" placeholder="Сообщение...">
            <button id="sendChat">Отправить</button>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <script src="/static/game.js"></script>
    <script>
        const API_URL = '/api/';
        let accessToken = localStorage.getItem('access_token');

        // Авторизация
        document.getElementById('registerBtn').addEventListener('click', async () => {
            const data = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            };
            try {
                const res = await fetch(API_URL + 'register/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const json = await res.json();
                if (res.ok) {
                    localStorage.setItem('access_token', json.access);
                    accessToken = json.access;
                    showGameButtons();
                } else {
                    document.getElementById('authError').textContent = json.error || 'Ошибка регистрации';
                }
            } catch (e) {
                document.getElementById('authError').textContent = 'Ошибка сети';
            }
        });

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };
            try {
                const res = await fetch(API_URL + 'login/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const json = await res.json();
                if (res.ok) {
                    localStorage.setItem('access_token', json.access);
                    accessToken = json.access;
                    showGameButtons();
                } else {
                    document.getElementById('authError').textContent = json.error || 'Ошибка входа';
                }
            } catch (e) {
                document.getElementById('authError').textContent = 'Ошибка сети';
            }
        });

        function showGameButtons() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('gameButtons').style.display = 'flex';
            // Чат показываем только в игре
            document.getElementById('chatContainer').classList.add('hidden');
        }

        document.getElementById('logout').addEventListener('click', () => {
            localStorage.removeItem('access_token');
            location.reload();
        });

        if (accessToken) showGameButtons();

        // Кнопки меню
        document.getElementById('startGame').addEventListener('click', () => {
            if (window.game) window.game.startNewGame();
            else alert('Игра не загружена');
        });

        document.getElementById('settings').addEventListener('click', () => {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('settingsMenu').classList.remove('hidden');
        });

        document.getElementById('tutorial').addEventListener('click', () => {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('tutorialMenu').classList.remove('hidden');
            document.getElementById('chatContainer').classList.add('hidden'); // Чат не показываем в обучении
        });

        document.getElementById('stats').addEventListener('click', async () => {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('statsMenu').classList.remove('hidden');
            // Загрузка статистики и лидерборда
            try {
                const res = await fetch(API_URL + 'leaderboard/');
                const json = await res.json();
                document.getElementById('leaderboardContent').innerHTML = '<h3>Лидерборд</h3>' + json.map(e => `<p>${e.user ? e.user.username : 'Гость'}: ${e.score}</p>`).join('');
            } catch (e) {
                document.getElementById('leaderboardContent').innerHTML = '<p>Ошибка загрузки лидерборда</p>';
            }
        });

        // Назад кнопки
        document.querySelectorAll('#backToMenu, #tutorialBack, #statsBack').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.hidden:not(#mainMenu)').forEach(el => el.classList.add('hidden'));
                document.getElementById('mainMenu').classList.remove('hidden');
                document.getElementById('chatContainer').classList.add('hidden');
            });
        });

        // ESC для возврата в меню
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.hidden:not(#mainMenu)').forEach(el => el.classList.add('hidden'));
                document.getElementById('mainMenu').classList.remove('hidden');
                document.getElementById('chatContainer').classList.add('hidden');
                if (window.game) window.game.pauseGame();
            }
        });

        // Сохранение/загрузка
        document.getElementById('saveGame')?.addEventListener('click', async () => {
            if (!accessToken) return alert('Авторизуйтесь');
            const data = {
                game_state: window.game?.getState() || {},
                score: window.game?.score || 0,
                level: window.game?.currentLevel || 1,
                time_played: window.game?.elapsedTime / 1000 || 0,
                is_completed: false
            };
            const res = await fetch(API_URL + 'game-sessions/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}`},
                body: JSON.stringify(data)
            });
            alert(res.ok ? 'Сохранено!' : 'Ошибка');
        });

        document.getElementById('loadGame')?.addEventListener('click', async () => {
            if (!accessToken) return alert('Авторизуйтесь');
            const res = await fetch(API_URL + 'load-session/', {
                headers: {'Authorization': `Bearer ${accessToken}`}
            });
            const json = await res.json();
            if (res.ok && window.game) {
                window.game.loadState(json.game_state);
                alert('Загружено!');
            } else alert('Нет сохранений');
        });

        // Чат (показываем только в игре)
        let ws;
        function initChat() {
            ws = new WebSocket(`ws://${window.location.host}/ws/chat/?token=${accessToken}`);
            ws.onopen = () => console.log('Chat connected');
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                document.getElementById('chatMessages').innerHTML += `<p><strong>${data.username}:</strong> ${data.message}</p>`;
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            };
            ws.onclose = () => console.log('Chat closed');
        }

        document.getElementById('sendChat').addEventListener('click', () => {
            const msg = document.getElementById('chatInput').value.trim();
            if (msg && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({message: msg}));
                document.getElementById('chatInput').value = '';
            }
        });

        // Показ чата только после старта игры
        document.getElementById('startGame').addEventListener('click', () => {
            document.getElementById('chatContainer').classList.remove('hidden');
            if (accessToken) initChat();
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (window.game) {
                console.log('Игра загружена');
            } else {
                console.error('game.js не загрузился');
                alert('Ошибка: Игра не загружена. Проверьте консоль.');
            }
        });
    </script>
</body>
</html>