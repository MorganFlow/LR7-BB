<!DOCTYPE html>
<html lang="ru">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Арканоид</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
    <div class="game-container">
        <div id="mainMenu" class="game-menu">
            <h1>Арканоид</h1>
            <div id="authSection">
                <input type="text" id="username" placeholder="Имя пользователя">
                <input type="email" id="email" placeholder="Email">
                <input type="password" id="password" placeholder="Пароль">
                <button id="registerBtn">Регистрация</button>
                <button id="loginBtn">Вход</button>
                <div id="authError" class="error"></div>
            </div>
            <div class="menu-buttons" id="gameButtons" style="display: none;">
                <button id="startGame">Начать игру</button>
                <button id="settings">Настройки</button>
                <button id="tutorial">Обучение</button>
                <button id="stats">Статистика</button>
                <button id="logout">Выход</button>
            </div>
        </div>

        <!-- Настройки -->
        <div id="settingsMenu" class="settings-menu hidden">
            <h2>Настройки</h2>
            <div class="setting-option">
                <label for="difficulty">Сложность:</label>
                <select id="difficulty">
                    <option value="easy">Легкий</option>
                    <option value="medium" selected>Средний</option>
                    <option value="hard">Сложный</option>
                </select>
            </div>
            <div class="setting-option">
                <label for="soundVolume">Громкость:</label>
                <input type="range" id="soundVolume" min="0" max="100" value="50">
            </div>
            <button id="saveSettings">Сохранить</button>
            <button id="backToMenu">Назад</button>
        </div>

        <!-- Обучение -->
        <div id="tutorialMenu" class="tutorial-menu hidden">
            <h2>Обучение</h2>
            <div class="tutorial-content">
                <p>Используйте мышь или ← → для платформы.</p>
                <p>Отбивайте шарик, разрушайте блоки.</p>
                <p>Не дайте шарику упасть!</p>
                <p><strong>Бонусы:</strong></p>
                <ul>
                    <li>Extend (зелёный): Увеличивает платформу</li>
                    <li>Shrink (красный): Уменьшает платформу</li>
                    <li>Multiball (жёлтый): Добавляет шарик</li>
                    <li>Slow (синий): Замедляет</li>
                    <li>Fast (фиолетовый): Ускоряет</li>
                    <li>Extra Life (оранжевый): +1 жизнь</li>
                </ul>
            </div>
            <button id="tutorialBack">Назад</button>
        </div>

        <!-- Статистика -->
        <div id="statsMenu" class="stats-menu hidden">
            <h2>Статистика</h2>
            <div id="statsContent"></div>
            <div id="leaderboardContent"></div>
            <button id="clearStats">Очистить</button>
            <button id="statsBack">Назад</button>
        </div>

        <!-- UI игры -->
        <div id="gameUI" class="game-ui hidden">
            <div class="score-display">
                <span>Уровень: <span id="currentLevel">1</span></span>
                <span>Очки: <span id="currentScore">0</span></span>
                <span>Время: <span id="gameTimer">00:00</span></span>
            </div>
            <button id="saveGame">Сохранить</button>
            <button id="loadGame">Загрузить</button>
            <button id="pauseGame">Пауза</button>
        </div>

        <!-- Чат -->
        <div id="chatContainer" class="chat-container hidden">
            <div id="chatMessages"></div>
            <input type="text" id="chatInput" placeholder="Сообщение...">
            <button id="sendChat">Отправить</button>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    {% load static %}
    <script src="{% static 'game.js' %}"></script>
    <script>
        const API_URL = '/api/';
        let accessToken = localStorage.getItem('access_token');

        // Авторизация
        document.getElementById('registerBtn').addEventListener('click', async () => {
            const data = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            };
            try {
                const res = await fetch(API_URL + 'register/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const json = await res.json();
                if (res.ok) {
                    localStorage.setItem('access_token', json.access);
                    accessToken = json.access;
                    showGameButtons();
                } else {
                    document.getElementById('authError').textContent = json.error || 'Ошибка';
                }
            } catch (e) {
                document.getElementById('authError').textContent = 'Ошибка сети';
            }
        });

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };
            try {
                const res = await fetch(API_URL + 'login/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const json = await res.json();
                if (res.ok) {
                    localStorage.setItem('access_token', json.access);
                    accessToken = json.access;
                    showGameButtons();
                } else {
                    document.getElementById('authError').textContent = json.error || 'Ошибка';
                }
            } catch (e) {
                document.getElementById('authError').textContent = 'Ошибка сети';
            }
        });

        function showGameButtons() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('gameButtons').style.display = 'flex';
        }

        document.getElementById('logout').addEventListener('click', () => {
            localStorage.removeItem('access_token');
            location.reload();
        });

        if (accessToken) showGameButtons();

        // Кнопки меню
        document.getElementById('startGame').addEventListener('click', () => {
            if (window.game) {
                window.game.startNewGame();
                document.getElementById('chatContainer').classList.remove('hidden');
            } else {
                alert('Игра не готова — обновите страницу');
            }
        });

        document.getElementById('settings').addEventListener('click', () => {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('settingsMenu').classList.remove('hidden');
        });

        document.getElementById('tutorial').addEventListener('click', () => {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('tutorialMenu').classList.remove('hidden');
        });

        document.getElementById('stats').addEventListener('click', () => {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('statsMenu').classList.remove('hidden');
            // Лидерборд
            fetch(API_URL + 'leaderboard/')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('leaderboardContent').innerHTML = '<h3>Лидерборд</h3>' + 
                        data.map(item => `<p>${item.user.username}: ${item.score} (сложность: ${item.difficulty})</p>`).join('');
                })
                .catch(() => document.getElementById('leaderboardContent').innerHTML = '<p>Ошибка загрузки</p>');
        });

        // Назад кнопки
        document.querySelectorAll('#backToMenu, #tutorialBack, #statsBack').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.hidden:not(#mainMenu)').forEach(el => el.classList.add('hidden'));
                document.getElementById('mainMenu').classList.remove('hidden');
            });
        });

        // ESC для меню
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.hidden:not(#mainMenu)').forEach(el => el.classList.add('hidden'));
                document.getElementById('mainMenu').classList.remove('hidden');
                if (window.game) window.game.pauseGame();
            }
        });

        // Сохранение/загрузка
        document.getElementById('saveGame').addEventListener('click', async () => {
            if (!accessToken) return alert('Авторизуйтесь');
            const data = {
                game_state: window.game.getState(),
                score: window.game.score,
                level: window.game.currentLevel,
                time_played: window.game.elapsedTime / 1000,
                is_completed: false
            };
            const res = await fetch(API_URL + 'game-sessions/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}`},
                body: JSON.stringify(data)
            });
            alert(res.ok ? 'Сохранено!' : 'Ошибка');
        });

        document.getElementById('loadGame').addEventListener('click', async () => {
            if (!accessToken) return alert('Авторизуйтесь');
            const res = await fetch(API_URL + 'load-session/', {
                headers: {'Authorization': `Bearer ${accessToken}`}
            });
            const json = await res.json();
            if (res.ok && window.game) {
                window.game.loadState(json.game_state);
                alert('Загружено!');
            } else alert('Нет сохранений');
        });

        // Чат
        let ws;
        function initChat() {
            ws = new WebSocket(`ws://${window.location.host}/ws/chat/?token=${accessToken}`);
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                document.getElementById('chatMessages').innerHTML += `<p>${data.username}: ${data.message}</p>`;
            };
        }

        document.getElementById('sendChat').addEventListener('click', () => {
            const msg = document.getElementById('chatInput').value;
            if (msg && ws) ws.send(JSON.stringify({message: msg}));
            document.getElementById('chatInput').value = '';
        });
    </script>
</body>
</html>